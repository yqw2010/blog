title: 京东首页前端技术架构分析
categories:
  - 前端杂烩
tags:
  - 京东
  - 技术架构
warning: true
date: 2015-09-09 10:35:05
description:
---

逛京东的时候开着 chrome 控制台，无意间看到了下面这串似曾相识的代码，

![京东网页部分源码](/blogimgs/2015/9/201593102.jpg)

再看了下 localstorage，

![京东网页 localstorage](/blogimgs/2015/9/201593103.jpg)

看到这些内容，其实京东首页的前端架构雏形就出来了。

<!--more-->

JD 使用 seajs 作为模块加载器，使用 jd-jquery 为基本库，看到它的 jq 版本是 1.6.4，

![jd-jQuery](/blogimgs/2015/9/201593104.jpg)

对比了下"正版" [jquery-1.6.4](http://code.jquery.com/jquery-1.6.4.min.js) 的源码，很显然，JD 使用的是自己造的轮子，这说明京东的前端生态应该是十分完善的，有轮子就会有很多组件、插件，这对一个公司批量造网页很有裨益。

### 前后端情况

电商的主页都是以呈现为主，展示各个横向市场和纵向市场的入口，也可能会有一些个性化（所谓个性化，就是给不同的用户推荐不同的内容）的推荐。它不像交易、详情等页面，页面逻辑后端重而前端轻，后端需要做各种内容推荐、数据校验、类型判断等工作，而前端更多的是将后端的信息有序地呈现出来。

首页则不同，首页承载了大量的二级页面入口和一些频道的推荐内容，而这些数据更多的是由运营去维护，可以认为数据是死的，就算存在一些个性化的数据，也会使用 jsonp 的形式去加载，前端需要快速高效地处理这些数据，可见前端任务相当艰巨。加上作为一个网站的门面，它的安全稳定性也是极为重要的。

如果没有猜错，京东后端也有一个中间层，中间层负责组装数据，以模块为单位，根据前端的请求响应对应模块的内容，而数据是在另外一个运营平台上维护，运营填好的数据会即时的推送到 CDN 或者应用，中间层拼合数据。看不到的东西就不猜测了，我们来看看京东首页的整体结构。

### 前端架构分析

如果希望一个网站跑起来飞快，你觉得怎么做最靠谱？

我们都玩过微博，都上过手机淘宝，进入这些 app 应用，会发现很多页面几乎看不到加载的痕迹，因为他们是本地应用，很多图片、脚本、样式都已经打包在本地了，所以加载起来速度是很快的。如果希望一个网页也能飞奔起来，同样的道理，让请求的个数少一点，让请求的内容少一点。还有一个至关重要的，让那些次要的内容慢一点加载（我们称之为懒加载）。

京东在按需加载和数据缓存上的工作做的十分到位。

![JD-page-loader](/blogimgs/2015/9/201593105.jpg)

每个具有 lazyload 异步标识的模块，都包含两个属性，一个是渲染该模块需要的内容（数据+JS），一个是这个内容过期的时间，只要内容不变就不会过期，所以这里使用的是文件 hash 来标注。

![JD-data-process-localstorage](/blogimgs/2015/9/201593106.jpg)

把需要请求的路径写在 dom 上，用户滚动时，一旦该模块进入了视窗，则请求 dom 上对应的 `data-path` 地址，拿到渲染这个模块所需要的脚本和数据，不过这中间还有一层本地缓存 localstorage，如果在本地缓存中匹配到了对应的 hash string 内容，则直接渲染，否则请求到数据之后更新本地缓存。dom 上的 `data-time` 会在页面加载时候，后端计算文件 hash，hash 不变则输出内容也不变。

这里其实存在两个请求，一个请求是加载数据和脚本，而这里的脚本内容是：

```javascript
seajs.use('path/to/$version$/script.js', function(Script){
  Script.init();
});
```
刚开始我还纳闷，为啥不在返回的内容中直接把脚本也输出出来？思考了下，京东的前端同学为了让数据充分缓存还真是下来不少功夫，数据的变化频率比较高，一旦数据变化，整个脚本都得重新加载，而将数据和脚本分离，脚本可以长期缓存在本地，数据则不用。如果脚本有变化，直接改变上没的 `$version$`